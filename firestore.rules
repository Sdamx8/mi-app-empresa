rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== FUNCIONES AUXILIARES =====
    
    // Verificar si el usuario está autenticado
    function isAuth() { 
      return request.auth != null; 
    }
    
    // Verificar si el usuario tiene un rol específico
    function hasRole(role) { 
      return isAuth() && request.auth.token.role == role; 
    }
    
    // Verificar si el usuario tiene cualquiera de los roles especificados
    function hasAnyRole(roles) {
      return isAuth() && request.auth.token.role in roles;
    }
    
    // Verificar si el estado permite modificaciones
    function canModifyByStatus(data) {
      return !(data.estado in ['finalizado', 'facturado', 'cancelado']);
    }
    
    // ===== REGLAS PARA REMISIONES =====

    match /remisiones/{remisionId} {
      // Permitir acceso completo a usuarios autenticados (temporal para desarrollo)
      allow read, write: if isAuth();
    }    // ===== REGLAS PARA HISTORIAL DE REMISIONES =====
    
    match /remisiones/{remisionId}/historial/{historialId} {
      // Lectura: técnicos, administrativos, directivos
      allow read: if isAuth() && hasAnyRole(['tecnico', 'administrativo', 'directivo']);
      
      // Creación: técnicos, administrativos, directivos (para registrar actividades)
      allow create: if isAuth() && hasAnyRole(['tecnico', 'administrativo', 'directivo']);
      
      // Actualización y eliminación: solo administrativos, directivos
      allow update, delete: if isAuth() && hasAnyRole(['administrativo', 'directivo']);
    }
    
    // ===== REGLAS PARA EMPLEADOS =====
    
    match /empleados/{empleadoId} {
      allow read, write: if isAuth();
    }
    
    match /EMPLEADOS/{empleadoId} {
      allow read, write: if isAuth();
    }
    
    // ===== REGLAS PARA SERVICIOS =====
    
    match /servicios/{servicioId} {
      allow read, write: if isAuth();
    }
    
    // ===== REGLAS PARA INFORMES TÉCNICOS =====

    match /informesTecnicos/{informeId} {
      allow read, write: if isAuth();
    }    // ===== REGLAS PARA HERRAMIENTAS =====

    match /HERRAMIENTA_ELECTRICA/{herramientaId} {
      allow read, write: if isAuth();
    }

    match /HERRAMIENTA_MANUAL/{herramientaId} {
      allow read, write: if isAuth();
    }

    match /herramientas/{herramientaId} {
      allow read, write: if isAuth();
    }    // ===== REGLAS PARA ESTADÍSTICAS =====

    match /technicianStats/{statId} {
      allow read, write: if isAuth();
    }

    // ===== REGLAS PARA HISTORIAL DE TRABAJOS (legacy) =====

    match /historialTrabajos/{trabajoId} {
      allow read, write: if isAuth();
    }
    
    // ===== REGLA POR DEFECTO PARA OTRAS COLECCIONES =====
    // Permitir acceso a usuarios autenticados (modo desarrollo)
    match /{document=**} {
      allow read, write: if isAuth();
    }
  }
}
